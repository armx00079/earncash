<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EarnCash Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f4f6f8;
}
.wrapper{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.box{
  background:white;
  padding:25px;
  border-radius:12px;
  text-align:center;
  width:90%;
  max-width:400px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
h2{margin-bottom:10px}
p{margin:6px 0;font-size:15px}
.balance{
  font-size:20px;
  font-weight:bold;
  margin:15px 0;
  color:green;
}
.btn{
  margin-top:12px;
  padding:12px 20px;
  border:none;
  border-radius:6px;
  font-size:16px;
  cursor:pointer;
  width:100%;
}
.enter{background:#5e239d;color:white}
.withdraw{background:#673ab7;color:white}
.profile{background:#009688;color:white}
.logout{background:#e53935;color:white}
</style>
</head>

<body>

<div class="wrapper">
  <div class="box">
    <h2>Welcome ðŸŽ‰</h2>

    <p id="name"></p>
    <p id="email"></p>

    <div class="balance">
      Balance: <span id="balance">0</span> Coins
    </div>

    <button class="btn enter" id="enterAppBtn">Enter App ðŸš€</button>
    <button class="btn profile" onclick="location.href='profile.html'">Profile ðŸ‘¤</button>
    <button class="btn withdraw" id="withdrawBtn">Withdraw ðŸ’°</button>
    <button class="btn logout" id="logoutBtn">Logout</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyBudDcoi0ybnrLpifDJGxYxfdF3eoSpDxM",
 authDomain:"earncash7-f0ecc.firebaseapp.com",
 projectId:"earncash7-f0ecc",
 appId:"1:1017767289580:web:56ecbedc90fe167d3dbbc9"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

onAuthStateChanged(auth, async(user)=>{
 if(!user){
   location.href="index.html";
   return;
 }

 const userRef = doc(db,"users",user.uid);
 const snap = await getDoc(userRef);

 /* ===========================
    ðŸ†• FIRST TIME USER
 =========================== */
 if(!snap.exists()){
   await setDoc(userRef,{
     name:user.displayName,
     email:user.email,
     balance:10,
     totalEarned:10,
     referredBy:null,
     referralRewarded:false,
     createdAt:new Date()
   });

   /* ðŸ”— REFERRAL CREDIT */
   const refUid = localStorage.getItem("ref_uid");
   if(refUid && refUid !== user.uid){
     const refRef = doc(db,"users",refUid);
     const refSnap = await getDoc(refRef);

     if(refSnap.exists() && !refSnap.data().referralRewarded){
       await updateDoc(refRef,{
         balance: increment(20),
         totalEarned: increment(20),
         referralRewarded: true
       });
     }

     await updateDoc(userRef,{ referredBy: refUid });
     localStorage.removeItem("ref_uid");
   }

   balance.innerText = 10;
 }
 else{
   balance.innerText = snap.data().balance;
 }

 name.innerText = "Name: " + user.displayName;
 email.innerText = "Email: " + user.email;
});

enterAppBtn.onclick = ()=>location.href="spin.html";
withdrawBtn.onclick = ()=>location.href="withdraw.html";
logoutBtn.onclick = ()=>signOut(auth).then(()=>location.href="index.html");
</script>

</body>
</html>
