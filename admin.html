<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#5e239d;color:#fff;padding:15px;text-align:center;font-size:20px}
.container{padding:15px}
.cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.card{background:#fff;border-radius:10px;padding:15px;box-shadow:0 4px 10px rgba(0,0,0,.1);font-weight:bold}
.green{color:#2e7d32}
.red{color:#c62828}
.purple{color:#5e239d}
.section{margin-top:25px;background:#fff;border-radius:10px;padding:15px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
.req{border-bottom:1px solid #eee;padding:10px 0}
button{padding:8px 14px;border:none;border-radius:6px;color:#fff;cursor:pointer;margin-right:5px}
.approve{background:#5e239d}
.reject{background:#e53935}

/* POPUP */
#balancePopup{
 display:none;position:fixed;top:0;left:0;right:0;bottom:0;
 background:rgba(0,0,0,.6);z-index:999;
 align-items:center;justify-content:center;
}
#balanceBox{
 background:white;padding:20px;border-radius:12px;width:280px;text-align:center
}
#balanceBox input{
 width:100%;padding:10px;margin:10px 0
}
</style>
</head>

<body>

<header>ğŸ”“ Admin Control Panel</header>

<div class="container">

<div class="cards">
  <div class="card purple">ğŸ‘¥ Total Users<br><span id="totalUsers">0</span></div>
  <div class="card green">ğŸ’° Total Deposits<br>â‚¹<span id="totalDeposits">0</span></div>
  <div class="card red">â³ Pending Deposits<br><span id="pendingDeposits">0</span></div>
  <div class="card purple">ğŸ§ Withdraw Requests<br><span id="pendingWithdraw">0</span></div>
</div>

<div class="section">
  <h3>ğŸ“Š Daily Profit Report</h3>
  <p>Deposits Today: â‚¹<span id="todayDeposit">0</span></p>
  <p>Withdraw Today: â‚¹<span id="todayWithdraw">0</span></p>
  <p class="green"><b>Profit: â‚¹<span id="todayProfit">0</span></b></p>
</div>

<div class="section">
  <h3>ğŸ’° Deposit Requests</h3>
  <div id="depositList"></div>
</div>

<div class="section">
  <h3>ğŸ§ Withdraw Requests</h3>
  <div id="withdrawList"></div>
</div>

<div class="section">
  <h3>ğŸ‘¤ User List</h3>
  <div id="userList"></div>
</div>

</div>

<!-- BALANCE POPUP -->
<div id="balancePopup">
  <div id="balanceBox">
    <h3>ğŸ’° Update Balance</h3>
    <input id="balAmount" type="number" placeholder="Enter amount">
    <button class="approve" onclick="addBal()">â• Add</button>
    <button class="reject" onclick="minusBal()">â– Minus</button><br><br>
    <button onclick="closeBal()">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore,collection,getDocs,doc,updateDoc,increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyBudDcoi0ybnrLpifDJGxYxfdF3eoSpDxM",
 authDomain:"earncash7-f0ecc.firebaseapp.com",
 projectId:"earncash7-f0ecc",
 appId:"1:1017767289580:web:56ecbedc90fe167d3dbbc9"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const today=new Date().toDateString();

let selectedUser="";

loadDashboard();

async function loadDashboard(){
 const users=await getDocs(collection(db,"users"));
 totalUsers.innerText=users.size;

 let totalDep=0,pendingDep=0,todayDep=0;
 const deposits=await getDocs(collection(db,"payments"));

 deposits.forEach(d=>{
  const x=d.data();
  if(x.status==="approved") totalDep+=x.amount;
  if(x.status==="pending") pendingDep++;
  if(x.status==="approved" && x.createdAt?.toDate().toDateString()===today)
    todayDep+=x.amount;
 });

 totalDeposits.innerText=totalDep;
 pendingDeposits.innerText=pendingDep;
 todayDeposit.innerText=todayDep;

 let pendingW=0,todayW=0;
 const withdraws=await getDocs(collection(db,"withdrawRequests"));

 withdraws.forEach(d=>{
  const x=d.data();
  if(x.status==="pending") pendingW++;
  if(x.status==="approved" && x.createdAt?.toDate().toDateString()===today)
    todayW+=x.amount;
 });

 pendingWithdraw.innerText=pendingW;
 todayWithdraw.innerText=todayW;
 todayProfit.innerText=todayDep-todayW;

 renderDeposits(deposits);
 renderWithdraws(withdraws);
 loadUsers();
}

function renderDeposits(snapshot){
 depositList.innerHTML="";
 snapshot.forEach(d=>{
  const x=d.data();
  if(x.status!=="pending") return;
  depositList.innerHTML+=`
   <div class="req">
    User: ${x.uid}<br>
    Amount: â‚¹${x.amount}<br>
    <button class="approve" onclick="approveDeposit('${d.id}','${x.uid}',${x.amount})">Approve</button>
    <button class="reject" onclick="rejectDeposit('${d.id}')">Reject</button>
   </div>`;
 });
}

window.approveDeposit=async(id,uid,amt)=>{
 await updateDoc(doc(db,"payments",id),{status:"approved"});
 await updateDoc(doc(db,"users",uid),{balance:increment(amt)});
 location.reload();
};
window.rejectDeposit=async(id)=>{
 await updateDoc(doc(db,"payments",id),{status:"rejected"});
 location.reload();
};

function renderWithdraws(snapshot){
 withdrawList.innerHTML="";
 snapshot.forEach(d=>{
  const x=d.data();
  if(x.status!=="pending") return;
  withdrawList.innerHTML+=`
   <div class="req">
    User: ${x.uid}<br>
    Amount: â‚¹${x.amount}<br>
    <button class="approve" onclick="approveWithdraw('${d.id}','${x.uid}',${x.amount})">Approve</button>
    <button class="reject" onclick="rejectWithdraw('${d.id}')">Reject</button>
   </div>`;
 });
}

window.approveWithdraw=async(id,uid,amt)=>{
 await updateDoc(doc(db,"withdrawRequests",id),{status:"approved"});
 await updateDoc(doc(db,"users",uid),{totalEarned:increment(-amt)});
 location.reload();
};
window.rejectWithdraw=async(id)=>{
 await updateDoc(doc(db,"withdrawRequests",id),{status:"rejected"});
 location.reload();
};

/* USER LIST + BALANCE */
async function loadUsers(){
 const snap=await getDocs(collection(db,"users"));
 userList.innerHTML="";
 snap.forEach(d=>{
  const u=d.data();
  userList.innerHTML+=`
   <div class="req">
    <b>${u.email || "No Email"}</b><br>
    Balance: â‚¹${u.balance}<br>
    <button class="approve" onclick="openBal('${d.id}')">Manage Balance</button>
   </div>`;
 });
}

window.openBal=(uid)=>{
 selectedUser=uid;
 balancePopup.style.display="flex";
};
window.closeBal=()=>balancePopup.style.display="none";

window.addBal=async()=>{
 const amt=parseInt(balAmount.value);
 if(!amt) return alert("Enter amount");
 await updateDoc(doc(db,"users",selectedUser),{balance:increment(amt)});
 location.reload();
};
window.minusBal=async()=>{
 const amt=parseInt(balAmount.value);
 if(!amt) return alert("Enter amount");
 await updateDoc(doc(db,"users",selectedUser),{balance:increment(-amt)});
 location.reload();
};
</script>

</body>
</html>
