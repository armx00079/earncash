<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore,doc,getDoc,updateDoc,increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyBudDcoi0ybnrLpifDJGxYxfdF3eoSpDxM",
 authDomain:"earncash7-f0ecc.firebaseapp.com",
 projectId:"earncash7-f0ecc",
 appId:"1:1017767289580:web:56ecbedc90fe167d3dbbc9"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const slices=[-60,-20,20,40,60,100,150,200];
const colors=["#4a148c","#6a1bb1","#7b2cbf","#8e44ad","#9b59b6","#6a1bb1","#7b2cbf","#4a148c"];
const spinCost=20;

const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const cx=150,cy=150,radius=140;
let userRef;

/* ðŸŽ¨ DRAW WHEEL */
function drawWheel(){
 const arc=2*Math.PI/slices.length;
 ctx.clearRect(0,0,300,300);
 slices.forEach((val,i)=>{
  const angle=i*arc;
  ctx.beginPath();
  ctx.fillStyle=colors[i];
  ctx.moveTo(cx,cy);
  ctx.arc(cx,cy,radius,angle,angle+arc);
  ctx.fill();

  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(angle+arc/2);
  ctx.fillStyle="#fff";
  ctx.font="bold 16px Arial";
  ctx.textAlign="right";
  ctx.fillText(val, radius-10,5);
  ctx.restore();
 });
}
drawWheel();

/* ðŸ” AUTH */
onAuthStateChanged(auth,async user=>{
 if(!user){location.href="index.html";return;}
 userRef=doc(db,"users",user.uid);
 const snap=await getDoc(userRef);
 wallet.innerText=snap.data().balance;
 winning.innerText=snap.data().totalEarned;
});

/* ðŸŽ° PERFECT SPIN LOGIC (ARROW MATCH FIX) */
spinBtn.onclick=async()=>{
 const snap=await getDoc(userRef);
 if(snap.data().balance < spinCost){
  alert("âŒ Minimum 20 coins required");
  return;
 }

 const spins=5;
 const randomDeg=Math.floor(Math.random()*360);
 const rotateTo=spins*360 + randomDeg;

 canvas.style.transition="transform 4s ease-out";
 canvas.style.transform=`rotate(${rotateTo}deg)`;

 // ðŸ”¥ POINTER IS AT TOP (270deg)
 const sliceDeg=360/slices.length;
 const fixedDeg=(360-(randomDeg+270)%360)%360;
 const index=Math.floor(fixedDeg/sliceDeg);
 const reward=slices[index];

 await updateDoc(userRef,{
  balance:increment(-spinCost + reward),
  totalEarned:increment(reward>0?reward:0)
 });

 setTimeout(async()=>{
  const s=await getDoc(userRef);
  wallet.innerText=s.data().balance;
  winning.innerText=s.data().totalEarned;
  alert("ðŸŽ¯ Result: â‚¹"+reward);
 },4000);
};

window.deposit=()=>location.href="deposit.html";
window.withdraw=()=>location.href="withdraw.html";
</script>
