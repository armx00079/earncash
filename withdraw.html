<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Withdraw</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f3f3f3;}
.header{background:#5e239d;color:#fff;text-align:center;padding:14px;font-size:20px;}
.card{background:#5e239d;color:white;margin:15px;border-radius:15px;padding:15px;display:flex;justify-content:space-between;}
.box{background:white;margin:15px;border-radius:15px;padding:20px;text-align:center;}
.input{width:100%;padding:14px;margin:10px 0;border-radius:30px;border:1px solid #ccc;font-size:16px;}
.btn{width:100%;background:#5e239d;color:white;padding:14px;border:none;border-radius:30px;font-size:18px;margin-top:10px;}
.note{font-size:14px;margin-top:8px;color:#444;}
.rules{
 margin:15px;background:#f9f9f9;border-radius:14px;
 padding:15px;font-size:14px;line-height:1.6;color:#555;
}
.rules div{margin-top:6px;}
.rules span{color:red;}
</style>
</head>

<body>

<div class="header">RozanaCash</div>

<div class="card">
  <div>Wallet ‚Çπ<span id="wallet">0</span></div>
  <div>Winning ‚Çπ<span id="winning">0</span></div>
</div>

<div class="box">
  <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/UPI-Logo.png" width="80"><br><br>

  <input class="input" id="upi" placeholder="Enter UPI ID">
  <input class="input" id="amount" type="number" placeholder="Enter Amount">

  <div class="note">Minimum withdraw ‚Çπ1000</div>

  <button class="btn" id="withdrawBtn">Withdraw</button>
</div>

<!-- üî¥ WITHDRAW RULES UI -->
<div class="rules">
  <div>üî¥ <b>Withdraw time</b> <span>00:05 - 23:55</span></div>
  <div>üî¥ <b>In-day Remaining Withdrawal Times</b> <span id="remainTimes">3</span></div>
  <div>üî¥ <b>Withdrawal amount range</b> <span>‚Çπ1,000.00 ‚Äì ‚Çπ50,000.00</span></div>
  <div>üî¥ Please confirm your beneficial account information before withdrawing.
    If your information is incorrect, our company will not be liable for the amount of loss.
  </div>
  <div>üî¥ If your beneficial information is incorrect, please contact customer service.</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  addDoc, 
  collection, 
  updateDoc, 
  increment 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBudDcoi0ybnrLpifDJGxYxfdF3eoSpDxM",
  authDomain: "earncash7-f0ecc.firebaseapp.com",
  projectId: "earncash7-f0ecc",
  appId: "1:1017767289580:web:56ecbedc90fe167d3dbbc9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userRef, withdrawControl;

function today(){
 const d=new Date();
 return d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
}

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="index.html"; return; }

  userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);
  wallet.innerText = snap.data().balance;
  winning.innerText = snap.data().totalEarned;

  // üî• fetch withdraw control
  const cSnap = await getDoc(doc(db,"admin","withdrawControl"));
  withdrawControl = cSnap.data();

  // show remaining times
  const userData = snap.data();
  const t = today();
  let count = userData.withdrawCount || 0;
  let last = userData.lastWithdrawDate || "";
  if(last !== t) count = 0;
  remainTimes.innerText = withdrawControl.dailyLimit - count;
});

withdrawBtn.onclick = async()=>{
  const upiId = upi.value.trim();
  const amt = Number(amount.value);

  if(!upiId) return alert("‚ùå Enter UPI ID");

  const min = withdrawControl.minWithdraw;
  const max = withdrawControl.maxWithdraw;
  const limit = withdrawControl.dailyLimit;

  if(!amt || amt < min || amt > max){
    alert(`‚ùå Withdrawal amount must be between ‚Çπ${min} and ‚Çπ${max}`);
    return;
  }

  const snap = await getDoc(userRef);
  let user = snap.data();

  if(user.totalEarned < amt){
    alert("‚ùå Insufficient winning");
    return;
  }

  const t = today();
  let count = user.withdrawCount || 0;
  let last = user.lastWithdrawDate || "";

  if(last !== t){
    count = 0;
    await updateDoc(userRef,{ withdrawCount:0, lastWithdrawDate:t });
  }

  if(count >= limit){
    alert("‚ùå Daily withdrawal limit reached (3 times)");
    return;
  }

  // ‚úÖ submit request
  await addDoc(collection(db,"withdrawRequests"),{
    uid: auth.currentUser.uid,
    email: auth.currentUser.email,
    upi: upiId,
    amount: amt,
    status: "Pending",
    createdAt: new Date()
  });

  await updateDoc(userRef,{
    totalEarned: increment(-amt),
    withdrawCount: increment(1),
    lastWithdrawDate: t
  });

  alert("‚úÖ Withdraw request submitted");
  location.reload();
};
</script>

</body>
</html>
